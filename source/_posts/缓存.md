---
title: 缓存
date: 2018-12-01 21:43:42
tags: 缓存
summary:
---
### 缓存
<span data-type="color" style="color:rgb(51, 51, 51)"><span data-type="background" style="background-color:rgb(255, 255, 255)">缓存就是数据交换的缓冲区（称作Cache），这个概念最初是来自于内存和CPU。当某一硬件要读取数据时，会首先从缓存中查找需要的数据，如果找到了则直接执行，找不到的话则从内存中找。由于缓存的运行速度比内存快得多，故缓存的作用就是帮助硬件更快地运行</span></span>

### <span data-type="color" style="color:rgb(51, 51, 51)"><span data-type="background" style="background-color:rgb(255, 255, 255)">浏览器缓存</span></span>
#### 强缓存
浏览器第一次请求数据时，服务器会将文件的过期时间和文件一起返回给客户端，客户端将二者备份至缓存中。再次请求数据时，客户端将根据文件的过期时间去判断，文件是否过期。文件未过期，则直接使用缓存中文件，文件过期了，则重新从服务器上获取。

`expires`是http1.0提出的一个表示资源过期时间的header，它描述的是一个绝对时间，即文件过期时间，由服务器返回。第二次请求时，将和本地时间比对，如果文件未过期则直接使用本地缓存，返回状态码200(from memory cache)或200(from disk cache)


![20181130104227.png | center | 539x479](https://cdn.nlark.com/yuque/0/2018/png/115449/1543545757681-41588cdb-cde0-415b-88b8-0b6d0741da93.png "")


`cache-control`第一次请求服务器时，响应头会返回一个 max-age，是文件多少时间后过期。第二次请求，客户端会校验文件是否过期，如果文件未过期则直接使用本地缓存，返回状态码200(from memory cache)或200(from disk cache)


![20181130104732.png | center | 535x481](https://cdn.nlark.com/yuque/0/2018/png/115449/1543546063708-4ce187d9-49f2-4396-8378-40d472b25e2e.png "")


cache-control: no-cache 必须先与代理服务器确认是否更改，然后在在决定使用缓存还是请求，类似于协商缓存（304）
cache-control: no-store 真正的不缓存数据到本地
cache-control: public 可以被所有用户缓存（多用户共享），包括终端和CDN等中间代理服务器
cache-control: private 只能被终端浏览器缓存（而且是私有缓存），不允许中继缓存服务器进行缓存
cache-control: must-revalidate 如果缓存内容失效，请求必须发送服务器进行验证
cache-control: max-age=s 缓存内容在s秒后失效，仅HTTP1.1可用

### 协商缓存
浏览器第一次请求数据时，服务器会将缓存标识与数据一起返回给客户端，客户端将二者备份至缓存中。 再次请求数据时，客户端将备份的缓存标识发送给服务器，服务器根据缓存标识进行判断，判断成功后，返回304状态码，通知客户端比较成功，可以使用缓存数据
#### Last-Modified/If-Modified-Since
通过文件的最后修改时间判断该不该读取缓存，服务端设置响应头Last-Modified,客户端把上次服务端响应头中的Last-modified值通过if-modified-since 传递给服务端 ， 服务端通过比较当前文件的修改时间和上次修改时间(上次传给客户端的值),如果相等那么说明文件修改时间没变也就是没变化，如果缓存文件未过期则返回304状态码，客户端使用缓存文件。如果缓存过期则返回新文件，状态码为200
Last-Modified的一次请求时，服务器返回的响应头里面包含缓存标识Last-Modified
Last-Modified的第二次请求时，请求头包含If-Modified-Since,服务器获取到该缓存标识后，用该标识和文件进行比对

![20181130111526.png | center | 479x597](https://cdn.nlark.com/yuque/0/2018/png/115449/1543547799880-95da67db-885d-45cc-9914-fbdcb0a7d795.png "")


#### Etag / If-None-Match
通过文件的内容来判断该不该读取缓存，服务端通过把文件内容读取出来，通过md5进行base64加密得出hash值，把这个值设置响应头Etag，客户端下一次请求通过if-none-match带过来，服务端再比对当前文件内容加密得出的hash值和上次是否一样，如果一样说明文件内容没有发生改变，这种方式是最准确的方式，但是也是最耗性能
Etag的第二次请求时，请求头包含If-None-Match,服务器获取到该缓存标识后，用该标识和文件进行比对。如果缓存文件未过期则返回304状态码，客户端使用缓存问题。如果缓存过期则返回新文件，状态码为200


![20181130112106.png | center | 482x589](https://cdn.nlark.com/yuque/0/2018/png/115449/1543548195892-8b5b157b-5a2f-4cd8-8491-3f6be513ad89.png "")


### CDN代理服务器缓存
CDN的全称是Content Delivery Network，即内容分发网络。CDN是构建在网络之上的内容分发网络，依靠部署在各地的边缘服务器，通过中心平台的负载均衡、内容分发、调度等功能模块，使用户就近获取所需内容，降低网络拥塞，提高用户访问响应速度和命中率。（CDN网络是在用户和服务器之间增加Cache层，如何将用户的请求引导到Cache上获得源服务器的数据，主要是通过接管DNS实现）
当用户点击网站页面上的内容URL，经过本地DNS系统解析，DNS系统会最终将域名的解析权交给CNAME指向的CDN专用DNS服务器。
CDN的DNS服务器将CDN的全局负载均衡设备IP地址返回用户。用户向CDN的全局负载均衡设备发起内容URL访问请求。CDN全局负载均衡设备根据用户IP地址，以及用户请求的内容URL，选择一台用户所属区域的区域负载均衡设备（边缘节点），告诉用户向这台设备发起请求。均衡设备把服务器的IP地址返回给用户。
用户向缓存服务器发起请求，缓存服务器响应用户请求，将用户所需内容传送到用户终端。如果这台缓存服务器上并没有用户想要的内容，而区域均衡设备依然将它分配给了用户，那么这台服务器就要向它的上一级缓存服务（多级缓存）器请求内容，直至追溯到网站的源服务器将内容拉到本地（回源）

### 服务端缓存
页面缓存，这种缓存技术一般用于不会经常变动信息，并且访问次数较多的页面，这样就不用每次都动态加载。
模板缓存，有些语言程序运行时动态对程序进行编译，为了避免每次请求都进行编译，则会缓存编译后的一个模板文件。
数据缓存，页面数据来自DB时，每次DB操作是需要消耗时间和资源的。将高频操作的数据放入到内存中，避免频繁的操作数据库

### 各缓存头的优先级
1. 强缓存和协商缓存同时存在，如果强缓存还在生效期则强制缓存覆盖协商缓存，协商缓存不生效；如果强缓存不在有效期，协商缓存生效。即：强缓存优先级 > 协商缓存优先级
2. 强缓存expires和cache-control同时存在时，则cache-control会覆盖expires，expires无论有没有过期，都无效。 即：cache-control优先级 > expires优先级
3. 协商缓存Etag和Last-Modified同时存在时，则Etag会覆盖Last-Modified，Last-Modified不会生效。即：ETag优先级 > Last-Modified优先级
4. 当然还有一种缓存pragma，和cache-control类似，前者是http1.0内容后者是http1.1内容，并且pragma优先级 > cache-control优先级，不过前者目前基本不使用。

由于大部分前端项目中css和js在打包时加了md5值，建议直接使用强缓存，并且expires和cache-control同时使用，建议设置时长为7天较为妥当。图片文件由于没有加md5值，建议采用协商缓存，html文件也建议采用协商缓存

ps: 当我们不设置cache-control，只设置协商缓存，在不同浏览器下会有不同的表现。chrome会直接从本地缓存获取，其他会请求服务器返回304。这时候有两种方式让他们的响应一致。
1、设置cache-control: public, max-age=0;记住，这里的public是关键。因为默认值是private，表示其他代理都不要缓存，只有服务器缓存，而max-age又为0，所以每次都会发起200的请求。设置public的意思就是允许其他各级代理缓存资源，因此如果资源没改变会返回304。 
2、直接设置max-age=1000。即是一秒之后内容过期，目的是触发浏览器缓存。也能达到想要304的效果

### 缓存的优点
* 提高响应速度，减少响应延迟
* 减少资源消耗（服务器、带宽）

### 缓存可能导致的问题
* 缓存雪崩，是指缓存使用不合理时，某一时间缓存失效，大量请求会直接到达向服务器，服务器无法承载大量请求，就导致服务器崩溃
* 缓存更新不及时，是指缓存使用不合理时，服务器文件更新，用户获取到的还是旧的错误的缓存文件

### 合理使用缓存
1. 分离变化的部分,经常变化的业务逻辑和基础工具库抽离
2. 对基础工具库可以设置长缓存Cache-Control: max-age=31536000
3. 对经常变化的因为逻辑可以使用短缓存时间+must-revalidate 或者使用协商缓存
4. 使用文件戳控制缓存