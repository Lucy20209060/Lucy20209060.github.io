<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Lucy"><title>Vue—v-if属性 · 长剑腥腥挂壁</title><meta name="description" content="v-if 示例1234567891011121314&amp;lt;div id='app'&amp;gt;  &amp;lt;p v-if='value === 1'&amp;gt;v-if&amp;lt;/p&amp;gt;  &amp;lt;p v-else-if='value === 2'&amp;gt;v-else-if&amp;lt;/p&amp;gt;  &amp;lt;"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/logo-2.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo-2.png" style="width:127px;"><h3 title><a href="/">长剑腥腥挂壁</a></h3></div></div><ul class="social-links"></ul></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/logo-2.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Vue—v-if属性</a></h3></div><div class="post-content"><h3 id="v-if-示例"><a href="#v-if-示例" class="headerlink" title="v-if 示例"></a>v-if 示例</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">'app'</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span> <span class="attr">v-if</span>=<span class="string">'value === 1'</span>&gt;</span>v-if<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span> <span class="attr">v-else-if</span>=<span class="string">'value === 2'</span>&gt;</span>v-else-if<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span> <span class="attr">v-else-if</span>=<span class="string">'value === 3'</span>&gt;</span>v-else-if<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span> <span class="attr">v-else</span>&gt;</span>v-else<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">  <span class="keyword">var</span> vm = <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">    el: <span class="string">'#app'</span>,</span></span><br><span class="line"><span class="undefined">    data: &#123;</span></span><br><span class="line"><span class="undefined">      value: 4</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>与其他指令相同，在<code>parse</code>函数中处理<code>v-if</code>指令，parse函数的作用是将HTML字符串转换为AST</p>
<h3 id="什么是AST"><a href="#什么是AST" class="headerlink" title="什么是AST"></a>什么是AST</h3><p>Vue源码中虚拟DOM构建经历 template编译成AST语法树 -&gt; 再转换为render函数，最终返回一个VNode(VNode就是Vue的虚拟DOM节点) <br>在Vue的mount过程中，template会被编译成AST语法树，AST是指抽象语法树（abstract syntax tree或者缩写为AST），或者语法树（syntax tree），是源代码的抽象语法结构的树状表现形式<br><br><br>比如，这是<code>&lt;div id=&#39;app&#39;&gt;</code>的AST语法树<br><img src="https://cdn.nlark.com/yuque/0/2019/png/115449/1550222090191-779b993c-5e15-4cff-abfa-a42b79b56ecc.png#align=left&amp;display=inline&amp;height=164&amp;linkTarget=_blank&amp;name=%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-02-15%2017.13.46.png&amp;originHeight=164&amp;originWidth=185&amp;size=15515&amp;width=185" alt="屏幕快照 2019-02-15 17.13.46.png"><br>包含属性列表，子节点，父节点，标签名称，节点类型及其他信息</p>
<h3 id="parse函数"><a href="#parse函数" class="headerlink" title="parse函数"></a>parse函数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">parse</span>(<span class="params">template</span>) </span>&#123;</span><br><span class="line">   <span class="keyword">var</span> currentParent;    <span class="comment">//当前父节点</span></span><br><span class="line">   <span class="keyword">var</span> root;            <span class="comment">//最终返回最终的AST树根节点</span></span><br><span class="line">   <span class="keyword">var</span> stack = [];</span><br><span class="line">   parseHTML(template, &#123;</span><br><span class="line">     start: <span class="function"><span class="keyword">function</span> <span class="title">start</span>(<span class="params">tag, attrs, unary</span>) </span>&#123;</span><br><span class="line">     	......</span><br><span class="line">     	<span class="keyword">if</span> (inVPre) &#123;</span><br><span class="line">        processRawAttrs(element);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!element.processed) &#123;</span><br><span class="line">        <span class="comment">// structural directives</span></span><br><span class="line">        processFor(element);</span><br><span class="line">        processIf(element);</span><br><span class="line">        processOnce(element);</span><br><span class="line">        <span class="comment">// element-scope stuff</span></span><br><span class="line">        processElement(element, options);</span><br><span class="line">      &#125;</span><br><span class="line">      ......</span><br><span class="line">     &#125;,</span><br><span class="line">     end: <span class="function"><span class="keyword">function</span> <span class="title">end</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">     ......</span><br><span class="line">     &#125;,</span><br><span class="line">     chars: <span class="function"><span class="keyword">function</span> <span class="title">chars</span>(<span class="params">text</span>) </span>&#123;</span><br><span class="line">     ......</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="keyword">return</span> root</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再看<code>processIf</code>函数</p>
<h3 id="processIf函数"><a href="#processIf函数" class="headerlink" title="processIf函数"></a>processIf函数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">processIf</span> (<span class="params">el</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> exp = getAndRemoveAttr(el, <span class="string">'v-if'</span>);</span><br><span class="line">  <span class="keyword">if</span> (exp) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(exp) <span class="comment">// "value === 1"</span></span><br><span class="line">    el.if = exp;</span><br><span class="line">    addIfCondition(el, &#123;</span><br><span class="line">      exp: exp,</span><br><span class="line">      block: el</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (getAndRemoveAttr(el, <span class="string">'v-else'</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(getAndRemoveAttr(el, <span class="string">'v-else'</span>)) <span class="comment">// ""</span></span><br><span class="line">      el.else = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> elseif = getAndRemoveAttr(el, <span class="string">'v-else-if'</span>); </span><br><span class="line">    <span class="keyword">if</span> (elseif) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(elseif) <span class="comment">// "value === 2/3"</span></span><br><span class="line">      el.elseif = elseif;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该函数的作用是<br>如果节点包含<code>v-if</code>属性<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> exp = getAndRemoveAttr(el, <span class="string">'v-if'</span>); <span class="comment">// value === 1</span></span><br><span class="line"><span class="keyword">if</span> (exp) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(el)</span><br><span class="line">  el.if = exp;</span><br><span class="line">  addIfCondition(el, &#123;</span><br><span class="line">    exp: exp,</span><br><span class="line">    block: el</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在AST中添加一个<code>if</code>属性<br><img src="https://cdn.nlark.com/yuque/0/2019/png/115449/1550223668598-cbcf3c45-803c-408f-9691-5e073498734c.png#align=left&amp;display=inline&amp;height=215&amp;linkTarget=_blank&amp;name=20190215174004.png&amp;originHeight=215&amp;originWidth=446&amp;size=30530&amp;width=446" alt="20190215174004.png"><br>addIfCondition函数会在AST中该el添加一个<code>ifConditions</code>属性来保存当前v-if相关元素</p>
<p>如果节点包含<code>v-else-if</code>属性，则在AST中添加一个<code>elseif</code>属性<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> elseif = getAndRemoveAttr(el, <span class="string">'v-else-if'</span>);</span><br><span class="line"><span class="keyword">if</span> (elseif) &#123;</span><br><span class="line">	el.elseif = elseif;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="https://cdn.nlark.com/yuque/0/2019/png/115449/1550224120956-ef022d92-8287-489e-9f55-8d50526d9498.png#align=left&amp;display=inline&amp;height=178&amp;linkTarget=_blank&amp;name=20190215174027.png&amp;originHeight=178&amp;originWidth=456&amp;size=25783&amp;width=456" alt="20190215174027.png"></p>
<p>接着走如下判断<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (currentParent &amp;&amp; !element.forbidden) &#123;</span><br><span class="line">  <span class="keyword">if</span> (element.elseif || element.else) &#123;</span><br><span class="line">  	processIfConditions(element, currentParent);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (element.slotScope) &#123;</span><br><span class="line">      <span class="comment">// scoped slot</span></span><br><span class="line">      <span class="comment">// keep it in the children list so that v-else(-if) conditions can</span></span><br><span class="line">      <span class="comment">// find it as the prev node.</span></span><br><span class="line">      <span class="keyword">var</span> name = element.slotTarget || <span class="string">'"default"'</span></span><br><span class="line">      ;(currentParent.scopedSlots || (currentParent.scopedSlots = &#123;&#125;))[name] = element;</span><br><span class="line">    &#125;</span><br><span class="line">    currentParent.children.push(element);</span><br><span class="line">    element.parent = currentParent;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从其中的判断可知，父节点的<code>children</code>中会有<code>v-if</code>的标签</p>
<p>如果节点包含<code>v-else</code>属性，则在AST中添加一个<code>else: true</code>属性<br><img src="https://cdn.nlark.com/yuque/0/2019/png/115449/1550224168597-b045e85f-2687-43c6-9eac-4dea90438325.png#align=left&amp;display=inline&amp;height=179&amp;linkTarget=_blank&amp;name=20190215174050.png&amp;originHeight=179&amp;originWidth=473&amp;size=24673&amp;width=473" alt="20190215174050.png"></p>
<p>接着也是同上操作</p>
<p>看下<code>processIfConditions</code>函数<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">processIfConditions</span> (<span class="params">el, parent</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> prev = findPrevElement(parent.children);</span><br><span class="line">  <span class="keyword">if</span> (prev &amp;&amp; prev.if) &#123;</span><br><span class="line">    addIfCondition(prev, &#123;</span><br><span class="line">      exp: el.elseif,</span><br><span class="line">      block: el</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    warn$<span class="number">2</span>(</span><br><span class="line">      <span class="string">"v-"</span> + (el.elseif ? (<span class="string">'else-if="'</span> + el.elseif + <span class="string">'"'</span>) : <span class="string">'else'</span>) + <span class="string">" "</span> +</span><br><span class="line">      <span class="string">"used on element &lt;"</span> + (el.tag) + <span class="string">"&gt; without corresponding v-if."</span>,</span><br><span class="line">      el.rawAttrsMap[el.elseif ? <span class="string">'v-else-if'</span> : <span class="string">'v-else'</span>]</span><br><span class="line">      );</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findPrevElement</span> (<span class="params">children</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> i = children.length;</span><br><span class="line">  <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">    <span class="keyword">if</span> (children[i].type === <span class="number">1</span>) &#123;</span><br><span class="line">    	<span class="keyword">return</span> children[i]</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (children[i].text !== <span class="string">' '</span>) &#123;</span><br><span class="line">        warn$<span class="number">2</span>(</span><br><span class="line">        <span class="string">"text \""</span> + (children[i].text.trim()) + <span class="string">"\" between v-if and v-else(-if) "</span> +</span><br><span class="line">        <span class="string">"will be ignored."</span>,</span><br><span class="line">        children[i]</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    	children.pop();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>findPrevElement</code>函数会先拿到el元素的前一个兄弟节点，然后从后往前寻找第一个节点，如果中间存在文本节点，会被删除并报错<br>如果<code>prev</code>元素存在且<code>prev.if</code>存在，则把当前节点和条件添加到<code>pre</code>的<code>ifConditions</code>中</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2019-02-17</span><i class="fa fa-tag"></i><a class="tag" href="/tags/vue/" title="vue">vue </a><a class="tag" href="/tags/v-if/" title="v-if">v-if </a></div></div></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2019/02/18/Vue—v-for属性/" title="Vue—v-for属性">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2019/02/15/Error-getaddrinfo/" title="Error: getaddrinfo ENOTFOUND localhost">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>